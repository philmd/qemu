language: c
git:
   submodules: false
env:
  global:
    - LC_ALL=C
  matrix:
    - IMAGE=debian-amd64-clang5
      SHIPPABLE_CONFIGURE_OPTS="--disable-docs --target-list=x86_64-softmmu,x86_64-linux-user"
    - IMAGE=debian-amd64-clang5
      SHIPPABLE_CONFIGURE_OPTS="--disable-docs --enable-debug"
      SCANNER="scan-build-5.0 -o shippable/testresults -maxloop 7 -no-failure-reports"
build:
  pre_ci:
    - make docker-image-${IMAGE} V=1
  pre_ci_boot:
    image_name: qemu
    image_tag: ${IMAGE}
    pull: false
    options: "-e HOME=/root"
  ci:
    - unset CC
    # some targets require newer up to date packages, for example TARGET_LIST matching
    # aarch64*-softmmu|arm*-softmmu|ppc*-softmmu|microblaze*-softmmu|mips64el-softmmu)
    # see the configure script:
    #    error_exit "DTC (libfdt) version >= 1.4.2 not present. Your options:"
    #    "  (1) Preferred: Install the DTC (libfdt) devel package"
    #    "  (2) Fetch the DTC submodule, using:"
    #    "      git submodule update --init dtc"
    - dpkg --compare-versions `dpkg-query --showformat='${Version}' --show libfdt-dev` ge 1.4.2 || git submodule update --init dtc
    - ./configure ${QEMU_CONFIGURE_OPTS} ${CONFIGURE_OPTS}
    - ${SCANNER} make -j$(($(getconf _NPROCESSORS_ONLN) + 1)) -k
