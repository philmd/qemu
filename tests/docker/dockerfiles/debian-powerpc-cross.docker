#
# Docker powerpc cross-compiler target
#
# This docker target builds on the debian sid base image which
# contains cross compilers for Debian "ports" targets. The original
# Jessie based no longer builds.
#
FROM qemu:debian-sid

RUN DEBIAN_FRONTEND=noninteractive eatmydata \
    apt-get install -y --no-install-recommends \
        gcc-powerpc-linux-gnu \
        libc6-dev-powerpc-cross || { echo "Failed to build - see debian-sid.docker notes"; exit 1; }

# Setup some basic tools we need
RUN DEBIAN_FRONTEND=noninteractive eatmydata \
    apt-get install -y --no-install-recommends \
        bison \
        binutils-multiarch \
        build-essential \
        ca-certificates \
        curl \
        flex \
        gettext \
        git \
        gnupg \
        pkg-config \
        python-minimal

RUN dpkg --add-architecture powerpc && \
    apt-get update

ENV PKG_CONFIG_PATH /usr/lib/powerpc-linux-gnu/pkgconfig

# Specify the cross prefix for this image (see tests/docker/common.rc)
ENV QEMU_CONFIGURE_OPTS --cross-prefix=powerpc-linux-gnu-

# <kludge> to fix "following packages have unmet dependencies" ...
ADD debian-apt-fake.sh /usr/local/bin/apt-fake
RUN apt-get install -y --no-install-recommends \
        equivs
RUN apt-fake install \
        glusterfs-common:powerpc=4.0.2-fake
# </kludge>

RUN DEBIAN_FRONTEND=noninteractive eatmydata \
    apt-get build-dep -yy -a powerpc qemu
RUN DEBIAN_FRONTEND=noninteractive \
    apt-get install -y --no-install-recommends \
        glusterfs-common:powerpc \
        libbz2-dev:powerpc \
        liblzo2-dev:powerpc \
        libncursesw5-dev:powerpc \
        libnfs-dev:powerpc \
        librdmacm-dev:powerpc \
        libsnappy-dev:powerpc
